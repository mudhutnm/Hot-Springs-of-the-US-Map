<!DOCTYPE html>
<html> 
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7, IE=9">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
      on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Hot Springs of the US - Map 4</title>

    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/js/esri/css/esri.css">
 
	<style> 
      html, body { height: 90%; width: 98%; margin: 1%; }
      #leftPane{
        width:20%; font-family: Verdana;
      }
      #legendPane{
        border: solid #97DCF2 2px; background-color:#F5F5DC; font-family: Verdana;
      }
	  #banner {height: 10%; width: 98%; margin: 1%; font-family: Verdana; font-size: 30px; text-align: center; color: #F5F5DC;
	  background-color: 33CCFF; background-image:url('hotcreek4.jpg'); background-position:center;
	  background-size:100%; background-repeat:no-repeat;}
	  
	  #search {
        display: block;
        position: absolute;
        z-index: 3;
        top: 20px;
        left: 375px;
    </style> 
	
    <script>var dojoConfig = { parseOnLoad: true };</script>
    <script src="http://serverapi.arcgisonline.com/jsapi/arcgis/3.3/"></script>
    <script>
      dojo.require("dijit.layout.BorderContainer");
      dojo.require("dijit.layout.ContentPane");
      dojo.require("esri.map");
      dojo.require("esri.dijit.Popup");
	  dojo.require("esri.layers.FeatureLayer");
	  dojo.require("dijit.layout.AccordionContainer");
	  dojo.require("esri.dijit.Legend");
	  dojo.require("esri.virtualearth.VETiledLayer");
      dojo.require("dijit.TitlePane");
      dojo.require("esri.dijit.BasemapGallery"); 
      //dojo.require("esri.arcgis.utils");
	  dojo.require("esri.dijit.Geocoder");
	  dojo.require("esri.dijit.Scalebar");
	   
      var map;
      var identifyTask, identifyParams;
      var geocoder;
	  
      function init() {
   
		var initExtent = new esri.geometry.Extent({"xmin":-11727455,"ymin":4861652,"xmax":-11706340,"ymax":4871512,"spatialReference":{"wkid":102100}});

		//setup the info popup window 
        var infopopup = new esri.dijit.Popup({
         fillSymbol: new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new 
		 esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255,0,0]), 2), new dojo.Color([100,255,0,0.25]))
		  }, dojo.create("div"));
   
		var gcpopup = new esri.dijit.Popup(null, dojo.create("div"));
   
        map = new esri.Map("map", {
          basemap: "topo",
          center: [-96.53, 38.374],
          zoom: 4,
          infoWindow: infopopup,
		  infoWindow: gcpopup,
        });
    


	//add the hot springs layer to the map
		var hotsprings = new esri.layers.ArcGISDynamicMapServiceLayer("https://gis.ngdc.noaa.gov/arcgis/rest/services/hot_springs/MapServer/0?f=pjson");
		


        map.addLayers([hotsprings]);
		
        dojo.connect(map, "onLoad", mapReady);
		
	        dojo.connect(map, "onLoad", mapReady);
        
		var scalebar = new esri.dijit.Scalebar({
        	    map: map,
            	scalebarUnit: "english"
          });
		    
		//add the legend
        dojo.connect(map,'onLayersAddResult',function(results){		
          var layerInfo = dojo.map(results, function(layer,index){
            return {layer:layer.layer,title:layer.layer.name};
          });
		  console.log(layerInfo.length)
          if(layerInfo.length > 0){
            var legendDijit = new esri.dijit.Legend({
              map:map,
			  autoUpdate:false,
              layerInfos:layerInfo
            },"legendDiv");
            legendDijit.startup();
          }
        });		
		
		
		// add a graphics layer for geocoding results
        map.addLayer(new esri.layers.GraphicsLayer({
          id: "results"
        }));
		
		// create the geocoder
        geocoder = new esri.dijit.Geocoder({ 
          autoNavigate: false, // zoom to best result
          maxLocations: 20, // increase number of results returned
          map: map,
          arcgisGeocoder: {
            url: "http://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer",
            name: "Esri World Geocoder",
            placeholder: "Find a place",
            sourceCountry: "USA" // limit search to the United States
          }
        }, "search");
        geocoder.startup();
        geocoder.focus();

        var symbol = new esri.symbol.PictureMarkerSymbol({
          "angle":0,
          "xoffset":0,
          "yoffset":10,
          "type":"esriPMS",
          "url":"http://static.arcgis.com/images/Symbols/Shapes/BluePin1LargeB.png",
          "contentType":"image/png",
          "width":24,
          "height":24
        });
		
		
        var gctemplate = new esri.InfoTemplate("${name}", "${*}");

        dojo.connect(geocoder, "onFindResults", function(response) {
          console.log("find results: ", response);
          var l = map.getLayer("results");
          l.clear();
          map.infoWindow.hide();
          dojo.forEach(response.results, function(r) {
            r.feature.attributes.name = r.name;
            r.feature.setSymbol(symbol);
            r.feature.setInfoTemplate(gctemplate);
            l.add(r.feature);
          });
        });
		
		 //add the basemap gallery, in this case we'll display maps from ArcGIS.com including bing maps
        var basemapGallery = new esri.dijit.BasemapGallery({
          showArcGISBasemaps: true,
          bingMapsKey: '',
          map: map
        }, "basemapGallery");
        basemapGallery.startup();
        
		dojo.connect(basemapGallery, "onError", function(msg) {console.log(msg)});
		
     	
      }
      
      function mapReady(map){
       dojo.connect(map,"onClick",executeIdentifyTask);
       //create identify tasks and setup parameters 
       identifyTask = new esri.tasks.IdentifyTask ("https://gis.ngdc.noaa.gov/arcgis/rest/services/hot_springs/MapServer/0?f=pjson");
       
       identifyParams = new esri.tasks.IdentifyParameters();
       identifyParams.tolerance = 3;
       identifyParams.returnGeometry = true;
       identifyParams.layerIds = [0];
       identifyParams.layerOption = "top";
       identifyParams.width  = map.width;
       identifyParams.height = map.height;
      }
      
      function executeIdentifyTask(evt) {
        identifyParams.geometry = evt.mapPoint;
        identifyParams.mapExtent = map.extent;
       
        var deferred = identifyTask.execute(identifyParams);

        deferred.addCallback(function(response) {     
          // response is an array of identify result objects    
          // Let's return an array of features.
          return dojo.map(response, function(result) {
            var feature = result.feature;
            feature.attributes.layerName = result.layerName;
            //if(result.layerName === 'Hot Springs')
			{
              console.log(feature.attributes.SPRING_NAME);
           var template = new esri.InfoTemplate("", "<p><b><u>Hot Spring</u></b> </p>Spring Name: ${Spring Name} <br/> Temperature  F: ${Temperature (F)}  <br/> State: ${State} <br/> USGS Quadrangle: ${Quadrangle} <br/> Latitude: ${Latitude} <br/> Longitude: ${Longitude}");
			  
			//  var template = new esri.InfoTemplate("Attributes", "${*}");
			  
              feature.setInfoTemplate(template);
            }
           // else if (result.layerName === 'Building Footprints'){
           //   var template = new esri.InfoTemplate("", "Parcel ID: ${PARCELID}");
           //   feature.setInfoTemplate(template);
           // }
            return feature;
          });
		  

      });

		
        // InfoWindow expects an array of features from each deferred
        // object that you pass. If the response from the task execution 
        // above is not an array of features, then you need to add a callback
        // like the one above to post-process the response and return an
        // array of features.
        map.infoWindow.setFeatures([ deferred ]);
		//map.infoWindow.setTitle("Hot Spring");
        map.infoWindow.show(evt.mapPoint);
      }
      	  
      dojo.ready(init);
    </script>
  </head>
  
  <!-- <body class="claro">
    <div data-dojo-type="dijit.layout.BorderContainer" data-dojo-props="design:'headline'"  style="width: 100%; height: 100%; margin: 0;">
      <div id="map" data-dojo-type="dijit.layout.ContentPane" data-dojo-props="region:'center'" style="border:3px solid #FF000;padding: 0px;">
     </div>
    </div>
  </body> -->

  <body class="claro"> 
  
	<div id="banner"><strong>Hot Springs of the US</strong></div>		 
			
    <div id="content" 
         data-dojo-type="dijit.layout.BorderContainer" 
         data-dojo-props="design:'headline', gutters:true" 
         style="width: 100%; height: 100%; margin: 0;"> 
		
		<div id="leftPane" 
           data-dojo-type="dijit.layout.ContentPane" 
           data-dojo-props="region:'left'">   
		   
			<div data-dojo-type="dijit.layout.AccordionContainer" id="accordion">
				<div data-dojo-type="dijit.layout.ContentPane" id="legendPane" 
					data-dojo-props="title:'<b>Legend</b>', selected:true">
					<div id="legendDiv">
					</div>
				</div>
				<div data-dojo-type="dijit.layout.ContentPane"

          data-dojo-props="title:'By Dan Sandhaus<p>Data Source: NOAA National Centers for 	  Environmental Information'" id="byline">
					
				</div>
			</div>
		</div>
		<div id="search"></div>
		<div id="map" 
			data-dojo-type="dijit.layout.ContentPane" 
			data-dojo-props="region:'center'" 
			style="overflow:hidden;"> 
			
			<div style="position:absolute; right:20px; top:10px; z-index: 1;">
          <div data-dojo-type="dijit.TitlePane" 
               data-dojo-props="title:'Switch Basemap', closable:false,  open:false">
            <div data-dojo-type="dijit.layout.ContentPane" style="width:380px; height:280px; overflow:auto;">
            <div id="basemapGallery" ></div></div>
          </div>
        </div>
		
		</div>
		
		

		
	</div> 
  </body>
  
  
</html>
